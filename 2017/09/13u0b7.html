<!-- build time:Thu Feb 14 2019 22:36:43 GMT+0800 (GMT+08:00) --><!DOCTYPE HTML><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="chrome=1"><title>简单直接的web服务器caddy | 唔多阁</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="author" content="(^_^)"><meta name="description" content="使用 caddy 申请 SSL 证书 渲染 mardown 同步 Git 代码 创建文件服务器等～"><meta name="description" content="使用 caddy 申请 SSL 证书 渲染 mardown 同步 Git 代码 创建文件服务器等～"><meta property="og:type" content="article"><meta property="og:title" content="简单直接的web服务器caddy"><meta property="og:url" content="https://cky2005.github.io/2017/09/13u0b7.html"><meta property="og:site_name" content="唔多阁"><meta property="og:description" content="使用 caddy 申请 SSL 证书 渲染 mardown 同步 Git 代码 创建文件服务器等～"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2017-11-25T11:41:54.445Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="简单直接的web服务器caddy"><meta name="twitter:description" content="使用 caddy 申请 SSL 证书 渲染 mardown 同步 Git 代码 创建文件服务器等～"><link rel="icon" type="image/x-icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/style.css"></head></html><body><div class="wrapper"><header id="header"><div class="title"><h1><a href="/">唔多阁</a></h1><p><a href="/">(学习笔记,备忘,纯属复制粘贴,无技术含量)</a></p></div><nav class="nav"><ul></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div class="content"><article class="post"><header><div class="icon"></div><a href="/2017/09/13u0b7.html"><time datetime="2017-09-13T04:00:00.000Z">2017-09-13</time></a><h1 class="title">简单直接的web服务器caddy</h1></header><div class="entry"><p>使用 caddy 申请 SSL 证书 渲染 mardown 同步 Git 代码 创建文件服务器等～<a id="more"></a></p><p>caddy 是用go语言开发的轻巧高性能的HTTP服务器，一个文件就能运行，不再像nginx 那样需要各种编译<br><a href="https://caddyserver.com/download" target="_blank" rel="noopener">官方下载</a> 或者 执行:<code>curl https://getcaddy.com | bash -s personal</code> 安装<br>安装Caddy前先用’netstat -lntp’ 这个命令查看’80端口’是否被其它软件占用,否则会安装失败.<br>安装caddy插件,如安装文件柜插件:<code>curl https://getcaddy.com | bash -s personal http.filemanager</code>.</p><h4 id="HTTP域名"><a href="#HTTP域名" class="headerlink" title="HTTP域名"></a>HTTP域名</h4><p>注意:”{“ 前面必须有空格<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">domain1.com:80, domain2.com:80 &#123;</span><br><span class="line">  root /home/wwwroot  # 网站目录</span><br><span class="line">  index index.php # 默认首页</span><br><span class="line"># 这里是配置</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h4 id="HTTPS-域名"><a href="#HTTPS-域名" class="headerlink" title="HTTPS 域名"></a>HTTPS 域名</h4><ul><li>关于caddy的自动申请网站证书:<br>手动指定 SSL证书和密匙 来配置的话，Caddy只会监听 443端口(https)，并不会自动设置 80端口(http)的重定向.<br>如果是Caddy自动申请的SSL证书的话,http就会自动跳转到https.<br><code>注意</code>:要有域名并且域名已解析绑定到你的服务器ip才能申请证书.</li></ul><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">domain.com:443 &#123;</span><br><span class="line">  root /var/www/notadd/public</span><br><span class="line">  index index.php</span><br><span class="line">  tls you@163.com   # 自动申请证书，必须在外网，且域名可访问</span><br><span class="line">  #  如果你有证书，可如下方式配置</span><br><span class="line">  # tls /home/ssl/domain.com.crt /home/ssl/domain.com.key</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="配置PHP转发-（Laravel为例）"><a href="#配置PHP转发-（Laravel为例）" class="headerlink" title="配置PHP转发 （Laravel为例）"></a>配置PHP转发 （Laravel为例）</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Laravel.com:80 &#123;</span><br><span class="line">        root /var/www/notadd/public</span><br><span class="line">        fastcgi / php-fpm:9000 php &#123;</span><br><span class="line">                index index.php</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        # To handle .html extensions with laravel change ext to</span><br><span class="line">        # ext / .html</span><br><span class="line"></span><br><span class="line">        rewrite &#123;</span><br><span class="line">                r .*</span><br><span class="line">                ext /</span><br><span class="line">                to /index.php?&#123;query&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        gzip   # 开启gzip</span><br><span class="line">        browse # 开启文件浏览</span><br><span class="line">        #日志</span><br><span class="line">        log /var/log/caddy/access.log</span><br><span class="line">        errors /var/log/caddy/error.log</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="markdown-渲染"><a href="#markdown-渲染" class="headerlink" title="markdown 渲染"></a>markdown 渲染</h4><p>caddy 可以直接帮你把md 文件渲染成网页<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">domian.com:80 &#123;</span><br><span class="line">  markdown /blog &#123; #指定md渲染路径为/blog</span><br><span class="line">    ext /data # 不进行渲染的目录</span><br><span class="line">    js /xxx/xx.js #指定js文件(可选)</span><br><span class="line">    css /xxx/xx.css #指定css文件(可选)</span><br><span class="line">    template [name] path # 模板，可不填，使用默认 ,模板优先与js,css设置,设置了模板,js,css设置就无效了</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>本人测试了,默认渲染比较简单,不写css/模板不能忍.</p><h4 id="自动从git-同步"><a href="#自动从git-同步" class="headerlink" title="自动从git 同步"></a>自动从git 同步</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">domian.com:80 &#123;</span><br><span class="line">  root /home</span><br><span class="line">  git https://github.com/notadd/notadd.git /var/www/ &#123;</span><br><span class="line">      key /home/git/domian.key # key 文件地址，公有库可忽略</span><br><span class="line">      interval 60 # 间隔60秒</span><br><span class="line">      # 或者使用钩子同步</span><br><span class="line">      hook /hook  password # hook地址和密钥，用于 github 等git 仓库推送更新。</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="创建文件下载服务器-插件"><a href="#创建文件下载服务器-插件" class="headerlink" title="创建文件下载服务器(插件)"></a>创建文件下载服务器(插件)</h4><p>需要说明的是，这个自带界面哦，还能在线编辑文件<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">domian.com:80 &#123;</span><br><span class="line">  root /home</span><br><span class="line">  filemanager</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h4 id="一行配置，负载均衡"><a href="#一行配置，负载均衡" class="headerlink" title="一行配置，负载均衡"></a>一行配置，负载均衡</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line">laravel.demo:<span class="number">80</span> &#123;</span><br><span class="line">    proxy / localhost:<span class="number">5001</span> localhost:<span class="number">5002</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#负载均衡三个后端之间的所有请求（使用随机策略）</span></span><br><span class="line">proxy / web1.local:<span class="number">80</span> web2.local:<span class="number">90</span> web3.local:<span class="number">100</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure><h4 id="一行配置解决跨域问题："><a href="#一行配置解决跨域问题：" class="headerlink" title="一行配置解决跨域问题："></a>一行配置解决跨域问题：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">laravel.demo:80 &#123;</span><br><span class="line">    root /home/wwwroot</span><br><span class="line">    cors</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="对于共享配置的站点，请指定多个地址："><a href="#对于共享配置的站点，请指定多个地址：" class="headerlink" title="对于共享配置的站点，请指定多个地址："></a>对于共享配置的站点，请指定多个地址：</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">localhost:8080, https://site.com, http://mysite.com &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="IP过滤"><a href="#IP过滤" class="headerlink" title="IP过滤"></a>IP过滤</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipfilter / &#123;</span><br><span class="line">    rule       block</span><br><span class="line">    ip         212.10.15.0-255 213.10.15.0-10 5.23.4.24</span><br><span class="line">    blockpage  /local/data/default.html</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="网站添加BasicAuth"><a href="#网站添加BasicAuth" class="headerlink" title="网站添加BasicAuth"></a>网站添加<code>BasicAuth</code></h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">basicauth / test 12345 #用户名test，密码 12345</span><br></pre></td></tr></table></figure><h4 id="错误页面"><a href="#错误页面" class="headerlink" title="错误页面:"></a>错误页面:</h4><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="comment">#定义默认，全部错误页面</span></span><br><span class="line">errors &#123;</span><br><span class="line">  * default_error.html</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 404 ,500</span></span><br><span class="line">errors &#123;</span><br><span class="line">  <span class="number">404</span> <span class="number">404.</span>html <span class="comment"># Not Found</span></span><br><span class="line">  <span class="number">500</span> <span class="number">500.</span>html <span class="comment"># Internal Server Error</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 错误记录文件</span></span><br><span class="line">errors /error.log</span><br></pre></td></tr></table></figure><h4 id="重定向"><a href="#重定向" class="headerlink" title="重定向"></a>重定向</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">redir 原路径 重定向后路径</span><br><span class="line">#重定向全部到 路径</span><br><span class="line">redir 路径</span><br></pre></td></tr></table></figure><hr><h4 id="caddy开机启动配置-centos7-debian-ubunto"><a href="#caddy开机启动配置-centos7-debian-ubunto" class="headerlink" title="caddy开机启动配置(centos7+,debian,ubunto):"></a>caddy开机启动配置(centos7+,debian,ubunto):</h4><p>/etc/systemd/system/caddy.service<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Caddy HTTP/2 web server</span><br><span class="line">Documentation=https://caddyserver.com/docs</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target systemd-networkd-wait-online.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Restart=on-abnormal</span><br><span class="line"></span><br><span class="line">; Always set &quot;-root&quot; to something safe in case it gets forgotten in the Caddyfile.</span><br><span class="line">ExecStart=/usr/local/bin/caddy -conf=/etc/caddy/Caddyfile</span><br><span class="line">ExecReload=/bin/kill -USR1 $MAINPID</span><br><span class="line"></span><br><span class="line">; Use graceful shutdown with a reasonable timeout</span><br><span class="line">KillMode=mixed</span><br><span class="line">KillSignal=SIGQUIT</span><br><span class="line">TimeoutStopSec=5s</span><br><span class="line"></span><br><span class="line">; Limit the number of file descriptors; see `man systemd.exec` for more limit settings.</span><br><span class="line">LimitNOFILE=1048576</span><br><span class="line">; Unmodified caddy is not expected to use more than that.</span><br><span class="line">LimitNPROC=512</span><br><span class="line"></span><br><span class="line">; Use private /tmp and /var/tmp, which are discarded after caddy stops.</span><br><span class="line">PrivateTmp=true</span><br><span class="line">; Use a minimal /dev</span><br><span class="line">PrivateDevices=true</span><br><span class="line">; Hide /home, /root, and /run/user. Nobody will steal your SSH-keys.</span><br><span class="line">ProtectHome=true</span><br><span class="line">; Make /usr, /boot, /etc and possibly some more folders read-only.</span><br><span class="line">ProtectSystem=full</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure><p></p><p>执行开机启动<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mkdir -p /etc/caddy &amp;&amp; chmod 644 /etc/systemd/system/caddy.service &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl start caddy.service</span><br></pre></td></tr></table></figure><p></p><hr><h4 id="centos6安装"><a href="#centos6安装" class="headerlink" title="centos6安装"></a>centos6安装</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># step 1, install caddyserver</span><br><span class="line">curl -s https://getcaddy.com | bash</span><br><span class="line">groupadd -g 33 www-data</span><br><span class="line">useradd \</span><br><span class="line">  -g www-data --no-user-group \</span><br><span class="line">  --home-dir /var/www --no-create-home \</span><br><span class="line">  --shell /usr/sbin/nologin \</span><br><span class="line">  --system --uid 33 www-data</span><br><span class="line"> </span><br><span class="line">mkdir /etc/caddy</span><br><span class="line">chown -R root:www-data /etc/caddy</span><br><span class="line">mkdir /etc/ssl/caddy</span><br><span class="line">chown -R www-data:root /etc/ssl/caddy</span><br><span class="line">chmod 0770 /etc/ssl/caddy</span><br><span class="line"> </span><br><span class="line"># step 2, download sysvinit file</span><br><span class="line">wget https://raw.githubusercontent.com/mholt/caddy/master/dist/init/linux-sysvinit/caddy -O /etc/init.d/caddy</span><br><span class="line"> </span><br><span class="line"># step 3, install daemon</span><br><span class="line">cd /usr/local/src</span><br><span class="line">wget http://developer.axis.com/download/distribution/apps-sys-utils-start-stop-daemon-IR1_9_18-2.tar.gz</span><br><span class="line">tar zxvf apps-sys-utils-start-stop-daemon-IR1_9_18-2.tar.gz</span><br><span class="line">cd apps/sys-utils/start-stop-daemon-IR1_9_18-2</span><br><span class="line">gcc start-stop-daemon.c -o start-stop-daemon</span><br><span class="line">cp start-stop-daemon /usr/sbin/</span><br><span class="line"> </span><br><span class="line"># step 4, start service</span><br><span class="line">service caddy start</span><br></pre></td></tr></table></figure><p>当然还有更多好玩的用法，参考官方文档： <a href="https://caddyserver.com/docs" target="_blank" rel="noopener">https://caddyserver.com/docs</a></p><p><a href="https://docs.getcaddy.cn/" target="_blank" rel="noopener">中文资料</a><br><a href="https://laravel-china.org/articles/4839/use-caddy-to-apply-ssl-certificates-render-mardown-synchronize-git-code-create-file-servers-and-so-on" target="_blank" rel="noopener">资料</a></p></div><footer><div class="clearfix"></div></footer></article></div></div><footer id="footer"><div class="copyright">&copy; 2019 <a href="/">(^_^)</a></div><div class="theme-copyright"><a href="javascript:scroll(0,0)">返回顶部</a> &nbsp; <a href="/archives/index.html">档案馆</a> &nbsp; <a href="/index.html">首页</a></div><div class="clearfix"></div></footer><script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/all.js"></script><script type="text/javascript">$(document).ready(function(){$(document).on("click",".fold_hider",function(){$(">.fold",this.parentNode).slideToggle(),$(">:first",this).toggleClass("open")}),$("div.fold").css("display","none")})</script></body><!-- rebuild by neat -->