<!-- build time:Tue Oct 17 2017 11:42:13 GMT+0800 (中国标准时间) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="chrome=1"><div id="squ-side"><div class="squ-sidec"><div style="text-align:left"><a href="javascript:scroll(0,0)"><font size="6">▲</font></a> <a href="/about/index.html"><i class="icon-copy icon-2x"></i></a> <a href="/index.html"><i class="icon-home icon-2x"></i></a></div></div><div class="squ-sideb"><div class="b">?</div></div></div><title>$$利用iptables实现中继(中转/端口转发)加速 | 唔多阁</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="author" content="(^_^)"><meta name="description" content="iptables配置"><meta name="description" content="iptables配置"><meta property="og:type" content="article"><meta property="og:title" content="$$利用iptables实现中继(中转&#x2F;端口转发)加速"><meta property="og:url" content="https://www.233666.org/2017/08/24/u005/index.html"><meta property="og:site_name" content="唔多阁"><meta property="og:description" content="iptables配置"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2017-09-16T11:39:15.918Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="$$利用iptables实现中继(中转&#x2F;端口转发)加速"><meta name="twitter:description" content="iptables配置"><link rel="icon" type="image/x-icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/style.css"></head></html><body><div class="wrapper"><header id="header"><div class="title"><h1><a href="/">唔多阁</a></h1><p><a href="/">(学习笔记,备忘,纯属复制粘贴,无技术含量)</a></p></div><nav class="nav"><ul></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div class="content"><article class="post"><header><div class="icon"></div><a href="/2017/08/24/u005/"><time datetime="2017-08-24T13:35:00.000Z">2017-08-24</time></a><h1 class="title">$$利用iptables实现中继(中转/端口转发)加速</h1></header><div class="entry"><h4 id="iptables配置"><a href="#iptables配置" class="headerlink" title="iptables配置"></a>iptables配置<a id="more"></a></h4><p>开启防火墙的ipv4转发<br></p><figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="comment"># 创建配置文件</span></div><div class="line"><span class="keyword">echo</span> -e <span class="string">"net.ipv4.ip_forward=1"</span> &gt;&gt; /etc/sysctl.conf</div><div class="line"><span class="comment"># iptables开机加载</span></div><div class="line">sysctl -p</div></pre></td></tr></table></figure><p></p><p>首先我们设置一下iptables 防火墙的开机启动自动载入规则功能。<br>CentOS 系统：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">service iptables save</div><div class="line">chkconfig --level 2345 iptables on</div></pre></td></tr></table></figure><p></p><p>Debian 系统：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables-save &gt; /etc/iptables.up.rules</div><div class="line">echo -e &apos;#!/bin/bash\n/sbin/iptables-restore &lt; /etc/iptables.up.rules&apos; &gt; /etc/network/if-pre-up.d/iptables</div><div class="line">chmod +x /etc/network/if-pre-up.d/iptables</div></pre></td></tr></table></figure><p></p><p>Ubuntu 系统：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables-save &gt; /etc/iptables.up.rules</div><div class="line">echo -e &apos;\npre-up iptables-restore &lt; /etc/iptables.up.rules\npost-down iptables-save &gt; /etc/iptables.up.rules&apos; &gt;&gt; /etc/network/interfaces</div><div class="line">chmod +x /etc/network/interfaces</div></pre></td></tr></table></figure><p></p><hr><h4 id="同端口-端口转发"><a href="#同端口-端口转发" class="headerlink" title="同端口 端口转发"></a>同端口 端口转发</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -t nat -A PREROUTING -p tcp --dport [本地端口] -j DNAT --to-destination [目标IP:目标端口]</div><div class="line">iptables -t nat -A PREROUTING -p udp --dport [本地端口] -j DNAT --to-destination [目标IP:目标端口]</div><div class="line">iptables -t nat -A POSTROUTING -p tcp -d [目标IP] --dport [目标端口] -j SNAT --to-source [本地服务器公网/私网IP]</div><div class="line">iptables -t nat -A POSTROUTING -p udp -d [目标IP] --dport [目标端口] -j SNAT --to-source [本地服务器公网/私网IP]</div></pre></td></tr></table></figure><p>在<code>中转服务器</code>上执行,示例:<br>假设你的国外服务器（被中转服务器）是 1.1.1.1 ，你的SS端口是 10000 ，而你这台<code>正在操作的VPS</code>的公网IP（中转服务器）是 2.2.2.2 。<br><code>注意：</code><br>本地服务器公网/私网IP：如果有私网ip，则应填私网IP，否则填公网IP(我在京东云试了,直接填公网ip不能连接,填私网ip才成功了)<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -t nat -A PREROUTING -p tcp -m tcp --dport 10000 -j DNAT --to-destination 1.1.1.1:10000</div><div class="line">iptables -t nat -A PREROUTING -p udp -m udp --dport 10000 -j DNAT --to-destination 1.1.1.1:10000</div><div class="line">iptables -t nat -A POSTROUTING -d 1.1.1.1 -p tcp -m tcp --dport 10000 -j SNAT --to-source 2.2.2.2</div><div class="line">iptables -t nat -A POSTROUTING -d 1.1.1.1 -p udp -m udp --dport 10000 -j SNAT --to-source 2.2.2.2</div></pre></td></tr></table></figure><p></p><p>这个时候你$$客户端填写Shadowsocks信息的时候，账号配置和端口填写都不变，只需要修改IP为中转服务器IP即可 。</p><hr><h4 id="不同端口-端口转发"><a href="#不同端口-端口转发" class="headerlink" title="不同端口 端口转发"></a>不同端口 端口转发</h4><p>将本地服务器(中转服务器 2.2.2.2 )的 10000 端口转发至目标IP(被中转服务器)为 1.1.1.1 的 30000 端口<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -t nat -A PREROUTING -p tcp -m tcp --dport 10000 -j DNAT --to-destination 1.1.1.1:30000</div><div class="line">iptables -t nat -A PREROUTING -p udp -m udp --dport 10000 -j DNAT --to-destination 1.1.1.1:30000</div><div class="line">iptables -t nat -A POSTROUTING -d 1.1.1.1 -p tcp -m tcp --dport 30000 -j SNAT --to-source 2.2.2.2</div><div class="line">iptables -t nat -A POSTROUTING -d 1.1.1.1 -p udp -m udp --dport 30000 -j SNAT --to-source 2.2.2.2</div></pre></td></tr></table></figure><p></p><p>这个时候你$$客户端填写信息的时候，端口应该填 10000 而不是 30000 。</p><h4 id="多端口-端口转发"><a href="#多端口-端口转发" class="headerlink" title="多端口 端口转发"></a>多端口 端口转发</h4><p>同端口 端口转发<br>将本地服务器(中转服务器 2.2.2.2 )的 10000~30000 端口转发至目标IP(被中转服务器)为 1.1.1.1 的 10000~30000 端口<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -t nat -A PREROUTING -p tcp -m tcp --dport 10000:30000 -j DNAT --to-destination 1.1.1.1:10000-30000</div><div class="line">iptables -t nat -A PREROUTING -p udp -m udp --dport 10000:30000 -j DNAT --to-destination 1.1.1.1:10000-30000</div><div class="line">iptables -t nat -A POSTROUTING -d 1.1.1.1 -p tcp -m tcp --dport 10000:30000 -j SNAT --to-source 2.2.2.2</div><div class="line">iptables -t nat -A POSTROUTING -d 1.1.1.1 -p udp -m udp --dport 10000:30000 -j SNAT --to-source 2.2.2.2</div></pre></td></tr></table></figure><p></p><p>这个时候你$$客户端填写信息的时候，账号配置和端口填写都不变，只需要修改IP为中转服务器IP即可 。</p><h4 id="不同端口-端口转发-1"><a href="#不同端口-端口转发-1" class="headerlink" title="不同端口 端口转发"></a>不同端口 端口转发</h4><p>将本地服务器(中转服务器 2.2.2.2 )的 10000~20000 端口转发至目标IP(被中转服务器)为 1.1.1.1 的 30000~40000 端口<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -t nat -A PREROUTING -p tcp -m tcp --dport 10000:20000 -j DNAT --to-destination 1.1.1.1:30000-40000</div><div class="line">iptables -t nat -A PREROUTING -p udp -m udp --dport 10000:20000 -j DNAT --to-destination 1.1.1.1:30000-40000</div><div class="line">iptables -t nat -A POSTROUTING -d 1.1.1.1 -p tcp -m tcp --dport 30000:40000 -j SNAT --to-source 2.2.2.2</div><div class="line">iptables -t nat -A POSTROUTING -d 1.1.1.1 -p udp -m udp --dport 30000:40000 -j SNAT --to-source 2.2.2.2</div></pre></td></tr></table></figure><p></p><p>这个时候你$$客户端填写信息的时候，端口应该填 10000~2000 而不是 30000~40000 。</p><h4 id="保存iptables配置"><a href="#保存iptables配置" class="headerlink" title="保存iptables配置"></a>保存iptables配置</h4><p>修改后记得保存 iptables配置，免得重启后没了。<br>CentOS 系统：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">service iptables save</div></pre></td></tr></table></figure><p></p><p>Debian 系统：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables-save &gt; /etc/iptables.up.rules</div></pre></td></tr></table></figure><p></p><p>查看NAT规则<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -t nat -vnL POSTROUTING</div><div class="line">iptables -t nat -vnL PREROUTING</div></pre></td></tr></table></figure><p></p><p>删除NAT规则<br>通过上面的查看规则命令，查看规则后，确定你要删除的规则的顺序，下面的命令是删除 第一个 规则。<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -t nat -D POSTROUTING 1</div><div class="line">iptables -t nat -D PREROUTING 1</div></pre></td></tr></table></figure><p></p><p><a href="https://doub.io/ss-jc34/" target="_blank" rel="external">转载自逗逼网</a></p><hr><h4 id="firewall一样也可以实现上述的功能，centos7不需要改用iptables。"><a href="#firewall一样也可以实现上述的功能，centos7不需要改用iptables。" class="headerlink" title="firewall一样也可以实现上述的功能，centos7不需要改用iptables。"></a>firewall一样也可以实现上述的功能，centos7不需要改用iptables。</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">echo 1 &gt; /proc/sys/net/ipv4/ip_forward</div></pre></td></tr></table></figure><h1 id="开启防火墙转发"><a href="#开启防火墙转发" class="headerlink" title="开启防火墙转发"></a>开启防火墙转发</h1><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">firewall-cmd --permanent --add-port=本地端口/tcp</div><div class="line">firewall-cmd --permanent --add-port=本地端口/udp</div><div class="line">firewall-cmd --permanent --add-masquerade</div><div class="line">firewall-cmd --permanent --add-forward-port=port=本地端口:proto=tcp:toport=被中转端口:toaddr=被中转IP</div><div class="line">firewall-cmd --permanent --add-forward-port=port=本地端口:proto=udp:toport=被中转端口:toaddr=被中转IP</div><div class="line">firewall-cmd --reload</div></pre></td></tr></table></figure></div><footer><div class="clearfix"></div></footer></article></div></div><footer id="footer"><div class="copyright">&copy; 2017 <a href="/">(^_^)</a></div><div class="theme-copyright"><a href="javascript:scroll(0,0)">返回顶部</a></div><div class="clearfix"></div></footer><script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/all.js"></script><script type="text/javascript">$(document).ready(function(){$(document).on("click",".fold_hider",function(){$(">.fold",this.parentNode).slideToggle(),$(">:first",this).toggleClass("open")}),$("div.fold").css("display","none")})</script></body><!-- rebuild by neat -->