<!-- build time:Fri Oct 13 2017 19:57:20 GMT+0800 (中国标准时间) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="chrome=1"><div id="squ-side"><div class="squ-sidec"><div style="text-align:left"><a href="/about/index.html"><i class="icon-copy icon-2x"></i></a> <a href="/index.html"><i class="icon-home icon-2x"></i></a></div></div><div class="squ-sideb"><div class="b">?</div></div></div><title>nginx-reverse-proxy-to-google-with-ssl | 唔多阁</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="author" content="(^_^)"><meta name="description" content="Nginx 反向代理 google.com:443"><meta name="description" content="Nginx 反向代理 google.com:443"><meta property="og:type" content="article"><meta property="og:title" content="nginx-reverse-proxy-to-google-with-ssl"><meta property="og:url" content="https://www.233666.org/2017/08/25/u006/index.html"><meta property="og:site_name" content="唔多阁"><meta property="og:description" content="Nginx 反向代理 google.com:443"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2017-10-12T14:47:12.224Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="nginx-reverse-proxy-to-google-with-ssl"><meta name="twitter:description" content="Nginx 反向代理 google.com:443"><link rel="icon" type="image/x-icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/style.css"></head></html><body><div class="wrapper"><header id="header"><div class="title"><h1><a href="/">唔多阁</a></h1><p><a href="/">(学习笔记,备忘,纯属复制粘贴,无技术含量)</a></p></div><nav class="nav"><ul></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div class="content"><article class="post"><header><div class="icon"></div><a href="/2017/08/25/u006/"><time datetime="2017-08-25T10:55:00.000Z">2017-08-25</time></a><h1 class="title">nginx-reverse-proxy-to-google-with-ssl</h1></header><div class="entry"><h4 id="Nginx-反向代理-google-com-443"><a href="#Nginx-反向代理-google-com-443" class="headerlink" title="Nginx 反向代理 google.com:443"></a>Nginx 反向代理 google.com:443<a id="more"></a></h4><p>google.conf<br></p><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">proxy_cache_path /var/nginx/cache/one	levels=1:2 keys_zone=one:10m	max_size=2g;</div><div class="line">proxy_cache_key	<span class="string">"<span class="variable">$host</span><span class="variable">$request_uri</span>"</span>;</div><div class="line">&nbsp</div><div class="line">upstream google &#123;</div><div class="line">server 74.125.224.71:80 max_fails=3;</div><div class="line">server 74.125.224.72:80 max_fails=3;</div><div class="line">server 74.125.224.73:80 max_fails=3;</div><div class="line">server 74.125.224.74:80 max_fails=3;</div><div class="line">server 74.125.224.75:80 max_fails=3;</div><div class="line">server 74.125.224.76:80 max_fails=3;</div><div class="line">server 74.125.224.77:80 max_fails=3;</div><div class="line">server 74.125.224.78:80 max_fails=3;</div><div class="line">server 74.125.224.79:80 max_fails=3;</div><div class="line">server 74.125.224.80:80 max_fails=3;</div><div class="line">&#125;</div><div class="line">&nbsp</div><div class="line">server &#123;</div><div class="line">listen 80;</div><div class="line">server_name g.foo.bar;</div><div class="line">rewrite ^(.*) https://g.foo.bar<span class="variable">$1</span> permanent;</div><div class="line">&#125;</div><div class="line">&nbsp</div><div class="line">server &#123;</div><div class="line">listen 443;</div><div class="line">server_name g.foo.bar;</div><div class="line">ssl on;</div><div class="line">ssl_certificate /etc/nginx/conf.d/ssl.crt;</div><div class="line">ssl_certificate_key /etc/nginx/conf.d/ssl.key;</div><div class="line">&nbsp</div><div class="line">location /&#123;</div><div class="line">proxy_cache one;</div><div class="line">proxy_cache_valid 200 302 1h;</div><div class="line">proxy_cache_valid 404 1m;</div><div class="line">proxy_redirect https://www.google.com/ /;</div><div class="line">proxy_cookie_domain google.com g.foo.bar;</div><div class="line">proxy_pass http://google;</div><div class="line">proxy_set_header Host <span class="string">"www.google.com"</span>;</div><div class="line">proxy_set_header Accept-Encoding <span class="string">""</span>;</div><div class="line">proxy_set_header User-Agent <span class="variable">$http_user_agent</span>;</div><div class="line">proxy_set_header Accept-Language <span class="string">"zh-CN"</span>;</div><div class="line">proxy_set_header Cookie <span class="string">"PREF=ID=a191d336be48dd1e:U=37318d643ff36958:FF=0:LD=en:NW=1:CR=2:TM=1404885843:LM=1411980439:GM=1:SG=1:S=SM8AYO7eUgOcZa8j"</span>;</div><div class="line">sub_filter www.google.com g.foo.bar;</div><div class="line">sub_filter_once off;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>请将 g.foo.bar 替换为你反向代理的 google 的域名</li><li>请将 /var/nginx/cache/one 替换为你的nginx缓存目录，max_size为缓存区大小，需要对应的权限设置；</li><li>upstream google 段是设置的 google 原始可正常访问的 IP 的负载均衡，可以在自己的服务器上 ping 一下 google，找到快的 IP；</li><li>反向代理中考虑到自动关键字提示，替换了对应的 cookie，如果被 google block，请尝试更换该 cookie 内容；</li><li>443 端口需要替换对应的证书，当然你用自己签发的也没关系，建议使用免费的 ssl 证书。</li></ul><h2 id="额外注意"><a href="#额外注意" class="headerlink" title="额外注意"></a>额外注意</h2><blockquote><p>nginx 启用了设置了密码的证书的 ssl 之后，每次 restart 或者 reload 需要输入证书的密码(类似于提示：Enter PEM pass phrase:)。<br>如果你觉得烦，解决方法如下：<br>openssl rsa -in 你的ssl密钥.key -out 你的ssl密钥.key.unsecure<br>然后将配置中的 ssl_certificate_key 你的 ssl 密钥.key; 更改为 ssl_certificate_key 你的 ssl 密钥.key.unsecure;</p></blockquote><p><a href="https://github.com/alexroyce315/nginx-reverse-proxy-to-google-with-ssl" target="_blank" rel="external">源地址</a></p></div><footer><div class="clearfix"></div></footer></article></div></div><footer id="footer"><div class="copyright">&copy; 2017 <a href="/">(^_^)</a></div><div class="theme-copyright"><a href="javascript:scroll(0,0)">返回顶部</a></div><div class="clearfix"></div></footer><script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/all.js"></script><script type="text/javascript">$(document).ready(function(){$(document).on("click",".fold_hider",function(){$(">.fold",this.parentNode).slideToggle(),$(">:first",this).toggleClass("open")}),$("div.fold").css("display","none")})</script></body><!-- rebuild by neat -->