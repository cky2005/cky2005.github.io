<!-- build time:Sun Sep 10 2017 17:01:12 GMT+0800 (中国标准时间) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="chrome=1"><title>nginx-reverse-proxy-to-google-with-ssl | 无名小站</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="author" content="(^_^)"><meta name="description" content="Nginx 反向代理 google.com:443"><meta name="description" content="Nginx 反向代理 google.com:443"><meta name="keywords" content="vps"><meta property="og:type" content="article"><meta property="og:title" content="nginx-reverse-proxy-to-google-with-ssl"><meta property="og:url" content="http://cky2005.github.com/2017/08/25/u006/index.html"><meta property="og:site_name" content="无名小站"><meta property="og:description" content="Nginx 反向代理 google.com:443"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2017-08-25T10:59:04.647Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="nginx-reverse-proxy-to-google-with-ssl"><meta name="twitter:description" content="Nginx 反向代理 google.com:443"><link rel="icon" type="image/x-icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/style.css"></head></html><body><div class="wrapper"><header id="header"><div class="title"><h1><a href="/">无名小站</a></h1><p><a href="/">缘来系你(学习笔记,备忘,纯属复制粘贴,无技术含量)</a></p></div><nav class="nav"><ul><li><a href="/">首页</a></li><li><a href="/archives">档案</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div class="content"><article class="post"><header><div class="icon"></div><a href="/2017/08/25/u006/"><time datetime="2017-08-25T10:55:00.000Z">2017-08-25</time></a><h1 class="title">nginx-reverse-proxy-to-google-with-ssl</h1></header><div class="entry"><h4 id="Nginx-反向代理-google-com-443"><a href="#Nginx-反向代理-google-com-443" class="headerlink" title="Nginx 反向代理 google.com:443"></a>Nginx 反向代理 google.com:443<a id="more"></a></h4><p>google.conf<br></p><figure class="highlight php"><table><tr><td class="code"><pre><div class="line">proxy_cache_path /<span class="keyword">var</span>/nginx/cache/one	levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=one:<span class="number">10</span>m	max_size=<span class="number">2</span>g;</div><div class="line">proxy_cache_key	<span class="string">"$host$request_uri"</span>;</div><div class="line"></div><div class="line">upstream google &#123;</div><div class="line">server <span class="number">74.125</span><span class="number">.224</span><span class="number">.71</span>:<span class="number">80</span> max_fails=<span class="number">3</span>;</div><div class="line">server <span class="number">74.125</span><span class="number">.224</span><span class="number">.72</span>:<span class="number">80</span> max_fails=<span class="number">3</span>;</div><div class="line">server <span class="number">74.125</span><span class="number">.224</span><span class="number">.73</span>:<span class="number">80</span> max_fails=<span class="number">3</span>;</div><div class="line">server <span class="number">74.125</span><span class="number">.224</span><span class="number">.74</span>:<span class="number">80</span> max_fails=<span class="number">3</span>;</div><div class="line">server <span class="number">74.125</span><span class="number">.224</span><span class="number">.75</span>:<span class="number">80</span> max_fails=<span class="number">3</span>;</div><div class="line">server <span class="number">74.125</span><span class="number">.224</span><span class="number">.76</span>:<span class="number">80</span> max_fails=<span class="number">3</span>;</div><div class="line">server <span class="number">74.125</span><span class="number">.224</span><span class="number">.77</span>:<span class="number">80</span> max_fails=<span class="number">3</span>;</div><div class="line">server <span class="number">74.125</span><span class="number">.224</span><span class="number">.78</span>:<span class="number">80</span> max_fails=<span class="number">3</span>;</div><div class="line">server <span class="number">74.125</span><span class="number">.224</span><span class="number">.79</span>:<span class="number">80</span> max_fails=<span class="number">3</span>;</div><div class="line">server <span class="number">74.125</span><span class="number">.224</span><span class="number">.80</span>:<span class="number">80</span> max_fails=<span class="number">3</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">listen <span class="number">80</span>;</div><div class="line">server_name g.foo.bar;</div><div class="line">rewrite ^(.*) https:<span class="comment">//g.foo.bar$1 permanent;</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">server &#123;</div><div class="line">listen <span class="number">443</span>;</div><div class="line">server_name g.foo.bar;</div><div class="line">ssl on;</div><div class="line">ssl_certificate /etc/nginx/conf.d/ssl.crt;</div><div class="line">ssl_certificate_key /etc/nginx/conf.d/ssl.key;</div><div class="line"></div><div class="line">location /&#123;</div><div class="line">proxy_cache one;</div><div class="line">proxy_cache_valid <span class="number">200</span> <span class="number">302</span> <span class="number">1</span>h;</div><div class="line">proxy_cache_valid <span class="number">404</span> <span class="number">1</span>m;</div><div class="line">proxy_redirect https:<span class="comment">//www.google.com/ /;</span></div><div class="line">proxy_cookie_domain google.com g.foo.bar;</div><div class="line">proxy_pass http:<span class="comment">//google;</span></div><div class="line">proxy_set_header Host <span class="string">"www.google.com"</span>;</div><div class="line">proxy_set_header Accept-Encoding <span class="string">""</span>;</div><div class="line">proxy_set_header User-Agent $http_user_agent;</div><div class="line">proxy_set_header Accept-Language <span class="string">"zh-CN"</span>;</div><div class="line">proxy_set_header Cookie <span class="string">"PREF=ID=a191d336be48dd1e:U=37318d643ff36958:FF=0:LD=en:NW=1:CR=2:TM=1404885843:LM=1411980439:GM=1:SG=1:S=SM8AYO7eUgOcZa8j"</span>;</div><div class="line">sub_filter www.google.com g.foo.bar;</div><div class="line">sub_filter_once off;</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p></p><ul><li>请将 g.foo.bar 替换为你反向代理的 google 的域名</li><li>请将 /var/nginx/cache/one 替换为你的nginx缓存目录，max_size为缓存区大小，需要对应的权限设置；</li><li>upstream google 段是设置的 google 原始可正常访问的 IP 的负载均衡，可以在自己的服务器上 ping 一下 google，找到快的 IP；</li><li>反向代理中考虑到自动关键字提示，替换了对应的 cookie，如果被 google block，请尝试更换该 cookie 内容；</li><li>443 端口需要替换对应的证书，当然你用自己签发的也没关系，建议使用免费的 ssl 证书。</li></ul><h2 id="额外注意"><a href="#额外注意" class="headerlink" title="额外注意"></a>额外注意</h2><blockquote><p>nginx 启用了设置了密码的证书的 ssl 之后，每次 restart 或者 reload 需要输入证书的密码(类似于提示：Enter PEM pass phrase:)。<br>如果你觉得烦，解决方法如下：<br>openssl rsa -in 你的ssl密钥.key -out 你的ssl密钥.key.unsecure<br>然后将配置中的 ssl_certificate_key 你的 ssl 密钥.key; 更改为 ssl_certificate_key 你的 ssl 密钥.key.unsecure;</p></blockquote><p><a href="https://github.com/alexroyce315/nginx-reverse-proxy-to-google-with-ssl" target="_blank" rel="external">源地址</a></p></div><footer><div class="tags"><a class="tags-link" href="/tags/vps/">vps</a></div><div class="clearfix"></div></footer></article></div></div><footer id="footer"><div class="copyright">&copy; 2017 <a href="/">(^_^)</a></div><div class="theme-copyright">Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a> | Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a></div><div class="clearfix"></div></footer><script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/all.js"></script></body><!-- rebuild by neat -->