<!-- build time:Wed Sep 13 2017 18:04:06 GMT+0800 (中国标准时间) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="chrome=1"><title>TLS 证书 | 无名小站</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="author" content="(^_^)"><meta name="description" content="使用 TLS 需要证书，证书也有免费付费的，同样的这里使用免费证书，证书认证机构为 Let’s Encrypt。"><meta name="description" content="使用 TLS 需要证书，证书也有免费付费的，同样的这里使用免费证书，证书认证机构为 Let’s Encrypt。"><meta property="og:type" content="article"><meta property="og:title" content="TLS 证书"><meta property="og:url" content="http://cky2005.github.com/2017/08/30/u0a8/index.html"><meta property="og:site_name" content="无名小站"><meta property="og:description" content="使用 TLS 需要证书，证书也有免费付费的，同样的这里使用免费证书，证书认证机构为 Let’s Encrypt。"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2017-08-30T03:17:46.881Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="TLS 证书"><meta name="twitter:description" content="使用 TLS 需要证书，证书也有免费付费的，同样的这里使用免费证书，证书认证机构为 Let’s Encrypt。"><link rel="icon" type="image/x-icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/style.css"></head></html><body><div class="wrapper"><header id="header"><div class="title"><h1><a href="/">无名小站</a></h1><p><a href="/">缘来系你(学习笔记,备忘,纯属复制粘贴,无技术含量)</a></p></div><nav class="nav"><ul><li><a href="/">首页</a></li><li><a href="/archives">档案</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div class="content"><article class="post"><header><div class="icon"></div><a href="/2017/08/30/u0a8/"><time datetime="2017-08-30T02:30:00.000Z">2017-08-30</time></a><h1 class="title">TLS 证书</h1></header><div class="entry"><p>使用 TLS 需要证书，证书也有免费付费的，同样的这里使用免费证书，证书认证机构为 <a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a>。<a id="more"></a> 证书的生成有许多方法，这里使用的是比较简单的方法：使用 acme.sh 脚本生成，本部分说明部分内容参考于<a href="https://github.com/Neilpang/acme.sh/blob/master/README.md" target="_blank" rel="external">acme.sh README</a>。</p><p>证书有两种，一种是 ECC 证书（内置公钥是 ECDSA 公钥），一种是 RSA 证书（内置 RSA 公钥）。简单来说，同等长度 ECC 比 RSA 更安全,也就是说在具有同样安全性的情况下，ECC 的密钥长度比 RSA 短得多（加密解密会更快）。但问题是 ECC 的兼容性会差一些，Android 4.x 以下和 Windows XP 不支持。只要您的设备不是非常老的老古董，强烈建议使用 ECC 证书。</p><p>以下将给出这两类证书的生成方法，请大家根据自身的情况自行选择其中一种证书类型。</p><p>证书生成只需在服务器上操作。</p><h4 id="安装-acme-sh"><a href="#安装-acme-sh" class="headerlink" title="安装 acme.sh"></a>安装 acme.sh</h4><p>执行以下命令，acme.sh 会安装到 ~/.acme.sh 目录下。<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">curl  https://get.acme.sh | sh</div></pre></td></tr></table></figure><p></p><p>示例:<br></p><figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$ curl  https:<span class="comment">//get.acme.sh | sh</span></div><div class="line">% Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                               Dload  Upload   Total   Spent    Left  Speed</div><div class="line"><span class="number">100</span>   <span class="number">671</span>  <span class="number">100</span>   <span class="number">671</span>    <span class="number">0</span>     <span class="number">0</span>    <span class="number">680</span>      <span class="number">0</span> --:--:-- --:--:-- --:--:--   <span class="number">679</span></div><div class="line">% Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                               Dload  Upload   Total   Spent    Left  Speed</div><div class="line"><span class="number">100</span>  <span class="number">112</span>k  <span class="number">100</span>  <span class="number">112</span>k    <span class="number">0</span>     <span class="number">0</span>   <span class="number">690</span>k      <span class="number">0</span> --:--:-- --:--:-- --:--:--  <span class="number">693</span>k</div><div class="line">[Fri <span class="number">30</span> Dec <span class="number">01</span>:<span class="number">03</span>:<span class="number">32</span> GMT <span class="number">2016</span>] Installing from online archive.</div><div class="line">[Fri <span class="number">30</span> Dec <span class="number">01</span>:<span class="number">03</span>:<span class="number">32</span> GMT <span class="number">2016</span>] Downloading https:<span class="comment">//github.com/Neilpang/acme.sh/archive/master.tar.gz</span></div><div class="line">[Fri <span class="number">30</span> Dec <span class="number">01</span>:<span class="number">03</span>:<span class="number">33</span> GMT <span class="number">2016</span>] Extracting master.tar.gz</div><div class="line">[Fri <span class="number">30</span> Dec <span class="number">01</span>:<span class="number">03</span>:<span class="number">33</span> GMT <span class="number">2016</span>] Installing to /home/user/.acme.sh</div><div class="line">[Fri <span class="number">30</span> Dec <span class="number">01</span>:<span class="number">03</span>:<span class="number">33</span> GMT <span class="number">2016</span>] Installed to /home/user/.acme.sh/acme.sh</div><div class="line">[Fri <span class="number">30</span> Dec <span class="number">01</span>:<span class="number">03</span>:<span class="number">33</span> GMT <span class="number">2016</span>] Installing alias to <span class="string">'/home/user/.profile'</span></div><div class="line">[Fri <span class="number">30</span> Dec <span class="number">01</span>:<span class="number">03</span>:<span class="number">33</span> GMT <span class="number">2016</span>] OK, Close <span class="keyword">and</span> reopen your terminal to start using acme.sh</div><div class="line">[Fri <span class="number">30</span> Dec <span class="number">01</span>:<span class="number">03</span>:<span class="number">33</span> GMT <span class="number">2016</span>] Installing cron job</div><div class="line">no crontab <span class="keyword">for</span> user</div><div class="line">no crontab <span class="keyword">for</span> user</div><div class="line">[Fri <span class="number">30</span> Dec <span class="number">01</span>:<span class="number">03</span>:<span class="number">33</span> GMT <span class="number">2016</span>] Good, bash is found, so change the shebang to <span class="keyword">use</span> <span class="title">bash</span> <span class="title">as</span> <span class="title">preferred</span>.</div><div class="line">[<span class="title">Fri</span> 30 <span class="title">Dec</span> 01:03:33 <span class="title">GMT</span> 2016] <span class="title">OK</span></div><div class="line">[<span class="title">Fri</span> 30 <span class="title">Dec</span> 01:03:33 <span class="title">GMT</span> 2016] <span class="title">Install</span> <span class="title">success</span>!</div></pre></td></tr></table></figure><p></p><p>安装成功后执行 <code>source ~/.bashrc</code> 以确保脚本所设置的命令别名生效。<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">source ~/.bashrc</div></pre></td></tr></table></figure><p></p><p>如果安装报错，那么可能是因为系统缺少 acme.sh 所需要的依赖项，acme.sh 的依赖项主要是 <code>netcat(nc)</code>，我们通过以下命令来安装这些依赖项，然后重新安装一遍 acme.sh:<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo apt-get -y install netcat</div></pre></td></tr></table></figure><p></p><h4 id="使用-acme-sh-生成证书"><a href="#使用-acme-sh-生成证书" class="headerlink" title="使用 acme.sh 生成证书"></a>使用 acme.sh 生成证书</h4><p>执行以下命令生成证书：<br>以下的命令会临时监听 80 端口，请确保执行该命令前 80 端口没有使用.(<code>mydomain.me修改为你的域名</code>)<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo ~/.acme.sh/acme.sh --issue -d mydomain.me --standalone -k ec-256</div></pre></td></tr></table></figure><p></p><p>示例:<br></p><figure class="highlight php"><table><tr><td class="code"><pre><div class="line">$ sudo ~/.acme.sh/acme.sh --issue -d mydomain.me --standalone -k ec<span class="number">-256</span></div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">12</span> HKT <span class="number">2016</span>] Standalone mode.</div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">12</span> HKT <span class="number">2016</span>] Single domain=<span class="string">'mydomain.me'</span></div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">12</span> HKT <span class="number">2016</span>] Getting domain auth token <span class="keyword">for</span> each domain</div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">12</span> HKT <span class="number">2016</span>] Getting webroot <span class="keyword">for</span> domain=<span class="string">'mydomain.me'</span></div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">12</span> HKT <span class="number">2016</span>] _w=<span class="string">'no'</span></div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">12</span> HKT <span class="number">2016</span>] Getting <span class="keyword">new</span>-authz <span class="keyword">for</span> domain=<span class="string">'mydomain.me'</span></div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">14</span> HKT <span class="number">2016</span>] The <span class="keyword">new</span>-authz request is ok.</div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">14</span> HKT <span class="number">2016</span>] mydomain.me is already verified, skip.</div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">14</span> HKT <span class="number">2016</span>] mydomain.me is already verified, skip http<span class="number">-01.</span></div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">14</span> HKT <span class="number">2016</span>] mydomain.me is already verified, skip http<span class="number">-01.</span></div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">14</span> HKT <span class="number">2016</span>] Verify finished, start to sign.</div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">16</span> HKT <span class="number">2016</span>] Cert success.</div><div class="line">-----BEGIN CERTIFICATE-----</div><div class="line">MIIEMTCCAxmgAwIBAgISA1+gJF5zwUDjNX/<span class="number">6</span>Xzz5fo3lMA0GCSqGSIb3DQEBCwUA</div><div class="line">MEoxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MSMwIQYDVQQD</div><div class="line">ExpMZXQncyBFbmNyeXB0IEF1dGhvcml0eSBYMzAeFw0xNjEyMjkyMzU5MDBaFw0x</div><div class="line">NzAzMjkyMzU5MDBaMBcxFTATBgNVBAMTDHdlYWtzYW5kLmNvbTBZMBMGByqGSM49</div><div class="line">****************************************************************</div><div class="line"><span class="number">4</span>p40tm0aMB837XQ9jeAXvXulhVH/<span class="number">7</span>/wWZ8/vkUUvuHSCYHagENiq/<span class="number">3</span>DYj4a85Iw9</div><div class="line">+<span class="number">6</span>u1r7atYHJ2VwqSamiyTGDQuhc5wdXIQxY/YQQqkAmn5tLsTZnnOavc4plANT40</div><div class="line">zweiG8vcIvMVnnkM0TSz8G1yzv1nOkruN3ozQkLMu6YS7lk/ENBN7DBtYVSmJeU2</div><div class="line">VAXE+zgRaP7JFOqK6DrOwhyE2LSgae83Wq/XgXxjfIo1Zmn2UmlE0sbdNKBasnf9</div><div class="line">gPUI45eltrjcv8FCSTOUcT7PWCa3</div><div class="line">-----END CERTIFICATE-----</div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">16</span> HKT <span class="number">2016</span>] Your cert is in  /root/.acme.sh/mydomain.me_ecc/mydomain.me.cer</div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">16</span> HKT <span class="number">2016</span>] Your cert key is in  /root/.acme.sh/mydomain.me_ecc/mydomain.me.key</div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">16</span> HKT <span class="number">2016</span>] The intermediate CA cert is in  /root/.acme.sh/mydomain.me_ecc/ca.cer</div><div class="line">[Fri Dec <span class="number">30</span> <span class="number">08</span>:<span class="number">59</span>:<span class="number">16</span> HKT <span class="number">2016</span>] <span class="keyword">And</span> the full chain certs is there:  /root/.acme.sh/mydomain.me_ecc/fullchain.cer</div></pre></td></tr></table></figure><p></p><p>-k 表示密钥长度，后面的值可以是 ec-256 、ec-284、2048、3072、4096、8192，带有 ec 表示生成的是 ECC 证书，没有则是 RSA 证书。在安全性上 256 位的 ECC 证书等同于 3072 位的 RSA 证书。</p><h4 id="证书更新"><a href="#证书更新" class="headerlink" title="证书更新"></a>证书更新</h4><p>由于 Let’s Encrypt 的证书有效期只有 3 个月，因此需要 90 天至少要更新一次证书，acme.sh 脚本会每 60 天自动更新证书。也可以手动更新。<br>手动更新 <code>ECC 证书</code>，执行：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo ~/.acme.sh/acme.sh --renew -d 域名 --force --ecc</div></pre></td></tr></table></figure><p></p><p>如果是 <code>RSA 证书</code>则执行：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo ~/.acme.sh/acme.sh --renew -d 域名 --force</div></pre></td></tr></table></figure><p></p><h4 id="安装证书和密钥"><a href="#安装证书和密钥" class="headerlink" title="安装证书和密钥"></a>安装证书和密钥</h4><p>ECC 证书<br>将证书和密钥安装到 /etc/v2ray 中：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo ~/.acme.sh/acme.sh --installcert -d 域名 --fullchainpath /etc/v2ray/v2ray.crt --keypath /etc/v2ray/v2ray.key --ecc</div></pre></td></tr></table></figure><p></p><p>RSA 证书<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sudo ~/.acme.sh/acme.sh --installcert -d 域名 --fullchainpath /etc/v2ray/v2ray.crt --keypath /etc/v2ray/v2ray.key</div></pre></td></tr></table></figure><p></p><h5 id="注意：无论什么情况，密钥-即上面的v2ray-key-都不能泄漏，如果你不幸泄漏了密钥，可以使用-acme-sh-将原证书吊销，再生成新的证书，吊销方法请自行参考-acme-sh-的手册"><a href="#注意：无论什么情况，密钥-即上面的v2ray-key-都不能泄漏，如果你不幸泄漏了密钥，可以使用-acme-sh-将原证书吊销，再生成新的证书，吊销方法请自行参考-acme-sh-的手册" class="headerlink" title="注意：无论什么情况，密钥(即上面的v2ray.key)都不能泄漏，如果你不幸泄漏了密钥，可以使用 acme.sh 将原证书吊销，再生成新的证书，吊销方法请自行参考 acme.sh 的手册"></a>注意：无论什么情况，密钥(即上面的v2ray.key)都不能泄漏，如果你不幸泄漏了密钥，可以使用 acme.sh 将原证书吊销，再生成新的证书，吊销方法请自行参考 acme.sh 的手册</h5><p><a href="https://toutyrater.github.io/advanced/tls.html" target="_blank" rel="external">link</a></p></div><footer><div class="clearfix"></div></footer></article></div></div><footer id="footer"><div class="copyright">&copy; 2017 <a href="/">(^_^)</a></div><div class="theme-copyright">Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a> | Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a></div><div class="clearfix"></div></footer><script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/all.js"></script></body><!-- rebuild by neat -->