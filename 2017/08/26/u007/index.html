<!-- build time:Sat Aug 26 2017 19:42:14 GMT+0800 (中国标准时间) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="chrome=1"><title>Linux 添加 SWAP 交换内存/虚拟内存 的简单方法 | 无名小站</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="author" content="(^_^)"><meta name="description" content="适当的添加一些虚拟内存，以避免内存不足的问题。"><meta name="description" content="适当的添加一些虚拟内存，以避免内存不足的问题。"><meta name="keywords" content="vps"><meta property="og:type" content="article"><meta property="og:title" content="Linux 添加 SWAP 交换内存&#x2F;虚拟内存 的简单方法"><meta property="og:url" content="http://cky2005.github.com/2017/08/26/u007/index.html"><meta property="og:site_name" content="无名小站"><meta property="og:description" content="适当的添加一些虚拟内存，以避免内存不足的问题。"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2017-08-26T03:15:18.189Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Linux 添加 SWAP 交换内存&#x2F;虚拟内存 的简单方法"><meta name="twitter:description" content="适当的添加一些虚拟内存，以避免内存不足的问题。"><link rel="icon" type="image/x-icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/style.css"><!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]--></head></html><body><div class="wrapper"><header id="header"><div class="title"><h1><a href="/">无名小站</a></h1><p><a href="/">缘来系你</a></p></div><nav class="nav"><ul><li><a href="/">首页</a></li><li><a href="/archives">档案</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div class="content"><article class="post"><header><div class="icon"></div><a href="/2017/08/26/u007/"><time datetime="2017-08-26T02:02:00.000Z">2017-08-26</time></a><h1 class="title">Linux 添加 SWAP 交换内存/虚拟内存 的简单方法</h1></header><div class="entry"><p>适当的添加一些虚拟内存，以避免内存不足的问题。<a id="more"></a></p><p>SWAP简单介绍<br>Linux的内存分为 物理内存 和 虚拟内存，虚拟内存(SWAP)也叫交换区、交换分区等。<br>当运行程序，产生进程时。系统会判断当前物理内存是否还有空闲内存 以允许进程调入内存运行，<br>如果有那么 则直接调入内存进行运行；如果没有，那么会根据优先级选择一个进程挂起，把该进<br>程交换到SWAP中等待，然后把新的进程调入到内存中运行。<br>根据这种换入和换出，实现了内存的循环利用，让用户感觉不到内存的限制。<br>从这也可以看出SWAP扮演了一个非常重要的角色，就是暂存被换出的进程。</p><p>当物理内存使用完或者达到一定比例之后，系统会自动使用SWAP做临时的内存使用。<br>当物理内存和SWAP都被使用完那么就会出错：out of memory<br>对于使用多大比例物理内存之后开始使用SWAP，在系统的配置文件中可以通过调整参数进行修改。<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">cat  /proc/sys/vm/swappiness</div></pre></td></tr></table></figure><p></p><p>默认是 60 ，一般不需要更改，当数值为 0 的时候，就会尽量使用物理内存直到用完<br>才会使用SWAP，当数值为 100 的时候，就会尽量使用SWAP。</p><p>SWAP是从硬盘中虚拟出来的，所以<code>速度由硬盘的读写速度决定</code>，如果你的Linux服务器IO很低，<br>硬盘是 HDD或者石头盘 钻石盘，那么效果会很差。<br>如果你的VPS没有SWAP，那么添加一些可能会提高性能，但不建议添加太多，<br>否则也是浪费，而且SWAP始终是硬盘虚拟的，比不上物理内存。</p><h3 id="注意：只有虚拟化构架为XEN、KVM、VM-Ware的VPS可以自己添加SWAP，OpenVZ不支持添加SWAP！"><a href="#注意：只有虚拟化构架为XEN、KVM、VM-Ware的VPS可以自己添加SWAP，OpenVZ不支持添加SWAP！" class="headerlink" title="注意：只有虚拟化构架为XEN、KVM、VM-Ware的VPS可以自己添加SWAP，OpenVZ不支持添加SWAP！"></a>注意：只有虚拟化构架为XEN、KVM、VM-Ware的VPS可以自己添加SWAP，OpenVZ不支持添加SWAP！</h3><h4 id="添加SWAP操作，必须是-root-用户才可以操作"><a href="#添加SWAP操作，必须是-root-用户才可以操作" class="headerlink" title="添加SWAP操作，必须是 root 用户才可以操作"></a>添加SWAP操作，必须是 root 用户才可以操作</h4><h4 id="检查硬盘大小"><a href="#检查硬盘大小" class="headerlink" title="检查硬盘大小"></a>检查硬盘大小</h4><p>因为SWAP是在硬盘中建立一个交换区文件，所以需要磁盘中最少有 这个文件大小 的空闲空间。<br>输入执行这个命令，即可看到你的VPS当前磁盘大小和使用情况：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">df -m</div></pre></td></tr></table></figure><p></p><p>从下面的示例中可以看到，这个VPS大概有 15GB的硬盘大小(14621 MB)，<br>用了 1GB(1117 MB)，剩下12.5GB(12763 MB)大小。<br>既然硬盘大小充足，那就可以继续下面步骤了。<br></p><figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="comment"># VPS示例提示 #</span></div><div class="line"><span class="comment"># 下列参数表头分别为：文件系统、总大小(单位MB)、已用大小(单位MB)、未用大小(单位MB)、使用率(%)、挂载点</span></div><div class="line">root@doub.io:~<span class="comment"># df -m</span></div><div class="line">Filesystem                                             <span class="number">1</span>M-blocks  Used Available <span class="keyword">Use</span>% <span class="title">Mounted</span> <span class="title">on</span></div><div class="line"><span class="title">rootfs</span>                                                     14621  1117     12763   9% /</div><div class="line"><span class="title">udev</span>                                                          10     0        10   0% /<span class="title">dev</span></div><div class="line"><span class="title">tmpfs</span>                                                         50     1        50   1% /<span class="title">run</span></div><div class="line">/<span class="title">dev</span>/<span class="title">disk</span>/<span class="title">by</span>-<span class="title">uuid</span>/12<span class="title">dc23</span>                                   14621  1117     12763   9% /</div><div class="line"><span class="title">tmpfs</span>                                                          5     0         5   0% /<span class="title">run</span>/<span class="title">lock</span></div><div class="line"><span class="title">tmpfs</span>                                                        202     0       202   0% /<span class="title">run</span>/<span class="title">shm</span></div><div class="line"># <span class="title">VPS</span>示例提示 #</div></pre></td></tr></table></figure><p></p><h4 id="添加交换区SWAP"><a href="#添加交换区SWAP" class="headerlink" title="添加交换区SWAP"></a>添加交换区SWAP</h4><p>查看一下当前的SWAP大小（单位 MB）。<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">free -m</div></pre></td></tr></table></figure><p></p><figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="comment"># VPS示例提示 #</span></div><div class="line">root@doub.io:~<span class="comment"># free -m</span></div><div class="line">             total       used       free     shared    buffers     cached</div><div class="line">Mem:           <span class="number">244</span>        <span class="number">141</span>        <span class="number">103</span>          <span class="number">0</span>         <span class="number">38</span>         <span class="number">76</span></div><div class="line">-/+ buffers/cache:         <span class="number">26</span>        <span class="number">218</span></div><div class="line">Swap:          <span class="number">127</span>          <span class="number">0</span>        <span class="number">127</span></div><div class="line"><span class="comment"># VPS示例提示 #</span></div></pre></td></tr></table></figure><h3 id="创建-SWAP文件"><a href="#创建-SWAP文件" class="headerlink" title="创建 SWAP文件"></a>创建 SWAP文件</h3><p>从上面的VPS示例中可以看到，这个VPS物理内存约等于 256MB，所以可以添加 物理内存<em>2的SWAP=512MB 。<br>bs 是字节数，这里是1024 B，count 是blocks块数，of 是要输出的SWAP交换区文件（本文章仅为示例，文件和位置可以自己改）<br>所以： bs=1024 B=1 KB，512000 </em>1 KB=512000 KB / 1024 ≈ 512 MB （为了直观的看，就按1000来算了）<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">dd if=/dev/zero of=/var/swapfile1 bs=1024 count=512000</div></pre></td></tr></table></figure><p></p><figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="comment"># VPS示例提示 #</span></div><div class="line">root@doub.io:~<span class="comment"># dd if=/dev/zero of=/var/swapfile1 bs=1024 count=512000</span></div><div class="line"><span class="number">512000</span>+<span class="number">0</span> records in</div><div class="line"><span class="number">512000</span>+<span class="number">0</span> records out</div><div class="line"><span class="number">524288000</span> bytes (<span class="number">524</span> MB) copied, <span class="number">4.09314</span> s, <span class="number">128</span> MB/s</div><div class="line"><span class="comment"># VPS示例提示 #</span></div></pre></td></tr></table></figure><p>查看文件是否创建成功，大小是否正确(因为按1000计算，所以会不足 512MB)<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">du -ah /var|grep &quot;swapfile1&quot;</div></pre></td></tr></table></figure><p></p><figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="comment"># VPS示例提示 #</span></div><div class="line">root@doub.io:~<span class="comment"># du -ah /var|grep "swapfile1"</span></div><div class="line"><span class="number">501</span>M	/<span class="keyword">var</span>/swapfile1</div></pre></td></tr></table></figure><h4 id="建立-SWAP文件"><a href="#建立-SWAP文件" class="headerlink" title="建立 SWAP文件"></a>建立 SWAP文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">mkswap /var/swapfile1</div></pre></td></tr></table></figure><figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="comment"># VPS示例提示 #</span></div><div class="line">root@doub.io:~<span class="comment"># mkswap /var/swapfile1</span></div><div class="line">Setting up swapspace version <span class="number">1</span>, size = <span class="number">511996</span> KiB</div><div class="line">no label, UUID=c48fef60<span class="number">-7</span>d49<span class="number">-450</span>c-bfd1<span class="number">-7</span>a7826de7cdd</div><div class="line"><span class="comment"># VPS示例提示 #</span></div></pre></td></tr></table></figure><h4 id="启用-SWAP文件"><a href="#启用-SWAP文件" class="headerlink" title="启用 SWAP文件"></a>启用 SWAP文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">swapon /var/swapfile1</div></pre></td></tr></table></figure><p>启用 SWAP文件没有任何提示，启用后我们查看一下是否正常启用：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">swapon -s</div><div class="line">free -m</div></pre></td></tr></table></figure><p></p><p>可以看到下面的SWAP中，成功添加启用了一个 SWAP交换区。<br></p><figure class="highlight php"><table><tr><td class="code"><pre><div class="line"><span class="comment"># VPS示例提示 #</span></div><div class="line">root@doub.io:~<span class="comment"># swapon -s</span></div><div class="line">Filename				Type		Size	Used	Priority</div><div class="line">/dev/vda2                               partition	<span class="number">131068</span>	<span class="number">0</span>	<span class="number">-1</span></div><div class="line">/<span class="keyword">var</span>/swapfile1                         file		<span class="number">511996</span>	<span class="number">0</span>	<span class="number">-2</span></div><div class="line"></div><div class="line">root@doub.io:~<span class="comment"># free -m</span></div><div class="line">             total       used       free     shared    buffers     cached</div><div class="line">Mem:           <span class="number">244</span>        <span class="number">240</span>          <span class="number">4</span>          <span class="number">0</span>         <span class="number">34</span>        <span class="number">175</span></div><div class="line">-/+ buffers/cache:         <span class="number">30</span>        <span class="number">214</span></div><div class="line">Swap:          <span class="number">627</span>          <span class="number">0</span>        <span class="number">627</span></div><div class="line"><span class="comment"># VPS示例提示 #</span></div></pre></td></tr></table></figure><p></p><h4 id="开机启动加载"><a href="#开机启动加载" class="headerlink" title="开机启动加载"></a>开机启动加载</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">echo &quot;/var/swapfile1 swap swap defaults 0 0&quot; &gt;&gt; /etc/fstab</div></pre></td></tr></table></figure><p>如果你又不想要刚才新添加的SWAP了，那么可以取消它们。</p><h4 id="取消-SWAP文件"><a href="#取消-SWAP文件" class="headerlink" title="取消 SWAP文件"></a>取消 SWAP文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">swapoff /var/swapfile1</div></pre></td></tr></table></figure><h4 id="取消-开机启动加载"><a href="#取消-开机启动加载" class="headerlink" title="取消 开机启动加载"></a>取消 开机启动加载</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">sed -i &quot;/swapfile1/d&quot; /etc/fstab</div></pre></td></tr></table></figure><p>取消后，可以再 <code>free -m</code> 查看一下SWAP，确定取消了，那么就可以删除 SWAP文件了。</p><h4 id="删除-SWAP文件"><a href="#删除-SWAP文件" class="headerlink" title="删除 SWAP文件"></a>删除 SWAP文件</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">rm -rf /var/swapfile1</div></pre></td></tr></table></figure><p><a href="https://doub.io/linux-jc7/" target="_blank" rel="external">转载自逗逼网</a></p><p>#直接添加，默认添加512M<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">function Make_Swap() &#123; local COUNT=$1 [ -n &quot;$COUNT&quot; ] &amp;&amp; COUNT=512 dd if=/dev/zero of=/swapfile count=$COUNT bs=1M mkswap /swapfile swapon /swapfile chmod 600 /swapfile [ -z &quot;`grep swapfile /etc/fstab`&quot; ] &amp;&amp; echo &apos;/swapfile swap swap defaults 0 0&apos; &gt;&gt; /etc/fstab &#125;</div></pre></td></tr></table></figure><p></p></div><footer><div class="tags"><a class="tags-link" href="/tags/vps/">vps</a></div><div class="clearfix"></div></footer></article></div></div><footer id="footer"><div class="copyright">&copy; 2017 <a href="/">(^_^)</a></div><div class="theme-copyright">Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a> | Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a></div><div class="clearfix"></div></footer><script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/scale.fix.js"></script><script src="/js/jquery.imagesloaded.min.js"></script><script src="/js/gallery.js"></script></body><!-- rebuild by neat -->