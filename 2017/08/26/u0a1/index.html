<!-- build time:Thu Sep 21 2017 01:49:30 GMT+0800 (中国标准时间) --><!DOCTYPE HTML><html><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="chrome=1"><title>一些有用的iptables规则 | 无名小站</title><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="author" content="(^_^)"><meta name="description" content="一些有用的iptables规则"><meta name="description" content="一些有用的iptables规则"><meta property="og:type" content="article"><meta property="og:title" content="一些有用的iptables规则"><meta property="og:url" content="https://kai2018.ml/2017/08/26/u0a1/index.html"><meta property="og:site_name" content="无名小站"><meta property="og:description" content="一些有用的iptables规则"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2017-09-16T11:40:40.995Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="一些有用的iptables规则"><meta name="twitter:description" content="一些有用的iptables规则"><link rel="icon" type="image/x-icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/style.css"></head></html><body><div class="wrapper"><header id="header"><div class="title"><h1><a href="/">无名小站</a></h1><p><a href="/">缘来系你(学习笔记,备忘,纯属复制粘贴,无技术含量)</a></p></div><nav class="nav"><ul><li><a href="/">首页</a></li><li><a href="/about">档案</a></li></ul><div class="clearfix"></div></nav><div class="clearfix"></div></header><div class="content"><article class="post"><header><div class="icon"></div><a href="/2017/08/26/u0a1/"><time datetime="2017-08-26T05:20:00.000Z">2017-08-26</time></a><h1 class="title">一些有用的iptables规则</h1></header><div class="entry"><h4 id="一些有用的iptables规则"><a href="#一些有用的iptables规则" class="headerlink" title="一些有用的iptables规则"></a>一些有用的iptables规则<a id="more"></a></h4><figure class="highlight php"><table><tr><td class="code"><pre><div class="line">iptables -I INPUT -p tcp –dport <span class="number">80</span> -m connlimit –connlimit-above <span class="number">30</span> -j REJECT</div><div class="line"><span class="comment"># 允许单个IP的最大连接数为 30</span></div><div class="line">iptables -t filter -A INPUT -p tcp –dport <span class="number">80</span> –tcp-flags FIN,SYN,RST,ACK SYN -m connlimit –connlimit-above <span class="number">10</span> –connlimit-mask <span class="number">32</span> -j REJECT</div><div class="line"><span class="comment"># iptables限制单个地址的并发连接数量</span></div><div class="line">iptables -t filter -A INPUT -p tcp –dport <span class="number">80</span> –tcp-flags FIN,SYN,RST,ACK SYN -m connlimit –connlimit-above <span class="number">10</span> –connlimit-mask <span class="number">24</span> -j REJECT</div><div class="line"><span class="comment"># 使用iptables限制单个c类子网的并发链接数量</span></div><div class="line">iptables -A INPUT -s <span class="number">192.168</span><span class="number">.0</span><span class="number">.8</span>|<span class="number">192.168</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">24</span> -p tcp –dport <span class="number">22</span> -j ACCEPT</div><div class="line"><span class="comment"># 只允许某IP或某网段的机器进行SSH连接</span></div><div class="line">iptables -A FORWARD -p TCP ! –syn -m state –state <span class="keyword">NEW</span> -j DROP</div><div class="line"><span class="comment"># 丢弃坏的TCP包</span></div><div class="line">iptables -A FORWARD -f -m limit –limit <span class="number">100</span>/s –limit-burst <span class="number">100</span> -j ACCEPT</div><div class="line"><span class="comment"># 处理IP碎片数量,防止攻击,允许每秒100个</span></div><div class="line">iptables -A FORWARD -p icmp -m limit –limit <span class="number">1</span>/s –limit-burst <span class="number">10</span> -j ACCEPT</div><div class="line"><span class="comment"># 设置ICMP包过滤,允许每秒1个包,限制触发条件是10个包</span></div><div class="line">iptables -A FORWARD -m state –state INVALID -j DROP</div><div class="line">iptables -A INPUT -m state –state INVALID -j DROP</div><div class="line">iptables -A OUTPUT -m state –state INVALID -j DROP</div><div class="line"><span class="comment"># 禁止非法连接</span></div><div class="line">iptables -N syn-flood</div><div class="line">iptables -A INPUT -p tcp –syn -j syn-flood</div><div class="line">iptables -A syn-flood -p tcp -m limit –limit <span class="number">3</span>/s –limit-burst <span class="number">6</span> -j <span class="keyword">RETURN</span></div><div class="line">iptables -A syn-flood -j REJECT</div><div class="line"><span class="comment"># 防止SYN攻击 轻量</span></div><div class="line">iptables -A INPUT -p tcp –syn –dport <span class="number">22</span> -j ACCEPT</div><div class="line">iptables -A OUTPUT -p tcp –syn –dport <span class="number">22</span> -j ACCEPT</div><div class="line"><span class="comment"># 允许访问22端口</span></div><div class="line">iptables -A INPUT -p tcp –syn –dport <span class="number">80</span> -j ACCEPT</div><div class="line">iptables -A OUTPUT -p tcp –syn –dport <span class="number">80</span> -j ACCEPT</div><div class="line"><span class="comment"># 允许访问80端口</span></div><div class="line">iptables -A INPUT -j REJECT</div><div class="line">iptables -A FORWARD -j REJECT</div><div class="line"><span class="comment"># 禁止其他未允许的规则访问(注意：如果22端口未加入允许规则，SSH链接会直接断开。</span></div></pre></td></tr></table></figure><hr><h4 id="限制来自某一IP的并发访问"><a href="#限制来自某一IP的并发访问" class="headerlink" title="限制来自某一IP的并发访问"></a>限制来自某一IP的并发访问</h4><figure class="highlight php"><table><tr><td class="code"><pre><div class="line">iptables -I INPUT -p tcp --dport <span class="number">80</span> -s xx.xx.xx.xx -m connlimit --connlimit-above <span class="number">10</span> -j REJECT</div><div class="line"><span class="comment">#上面这条iptables的详细解释:</span></div><div class="line">-I INPUT</div><div class="line"><span class="comment">#表示要插入一条 INPUT 链的规则</span></div><div class="line">-p tcp --dport <span class="number">80</span> -s xx.xx.xx.xx</div><div class="line"><span class="comment"># 是针对来自 xx.xx.xx.xx 这个IP对于本机80端口的tcp请求</span></div><div class="line">-m connlimit --connlimit-above <span class="number">10</span></div><div class="line"><span class="comment"># 表示匹配条件，并发数大于10时成立</span></div><div class="line">-j REJECT</div><div class="line"><span class="comment"># 满足条件后要执行的动作：拒绝</span></div></pre></td></tr></table></figure><h4 id="允许每个IP最多有2个连接到本机的22端口。"><a href="#允许每个IP最多有2个连接到本机的22端口。" class="headerlink" title="允许每个IP最多有2个连接到本机的22端口。"></a>允许每个IP最多有2个连接到本机的22端口。</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables –A INPUT –p tcp –dport 22 –m connlimit –connlimit-above 2 –j REJECT</div></pre></td></tr></table></figure><h4 id="每个IP最多2个初始连接"><a href="#每个IP最多2个初始连接" class="headerlink" title="每个IP最多2个初始连接"></a>每个IP最多2个初始连接</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -I  INPUT -p tcp –syn -m connlimit –connlimit-above 2 -j DROP</div></pre></td></tr></table></figure><h4 id="单个IP在60秒内只允许新建20个连接-这里假设web端口是80"><a href="#单个IP在60秒内只允许新建20个连接-这里假设web端口是80" class="headerlink" title="单个IP在60秒内只允许新建20个连接,这里假设web端口是80,"></a>单个IP在60秒内只允许新建20个连接,这里假设web端口是80,</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -I  INPUT -i eth0 -p tcp -m tcp –dport 80 -m state –state NEW -m recent –update –seconds 60 –hitcount 20 –name DEFAULT –rsource -j DROP</div><div class="line">iptables -I  INPUT -i eth0 -p tcp -m tcp –dport 80 -m state –state NEW -m recent –set –name DEFAULT –rsource</div></pre></td></tr></table></figure><h4 id="防止syn攻击-限制单个ip的最大syn连接数"><a href="#防止syn攻击-限制单个ip的最大syn连接数" class="headerlink" title="防止syn攻击(限制单个ip的最大syn连接数)"></a>防止syn攻击(限制单个ip的最大syn连接数)</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables –A INPUT –i eth0 –p tcp --syn -m connlimit --connlimit-above 15 -j DROP</div></pre></td></tr></table></figure><h4 id="利用recent模块抵御DOS攻击"><a href="#利用recent模块抵御DOS攻击" class="headerlink" title="利用recent模块抵御DOS攻击"></a>利用recent模块抵御DOS攻击</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -I INPUT -p tcp -dport 22 -m connlimit --connlimit-above 3 -j DROP</div></pre></td></tr></table></figure><h4 id="单个ip对多连接3个会话"><a href="#单个ip对多连接3个会话" class="headerlink" title="单个ip对多连接3个会话"></a>单个ip对多连接3个会话</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -I INPUT -p tcp --dport 22 -m state --state NEW -m recent --set --name SSH</div></pre></td></tr></table></figure><h4 id="5分钟内尝试次数达到3次，就拒绝提供SSH列表中的这个IP服务。5分钟后即可恢复（更改SSH端口也可）"><a href="#5分钟内尝试次数达到3次，就拒绝提供SSH列表中的这个IP服务。5分钟后即可恢复（更改SSH端口也可）" class="headerlink" title="5分钟内尝试次数达到3次，就拒绝提供SSH列表中的这个IP服务。5分钟后即可恢复（更改SSH端口也可）"></a>5分钟内尝试次数达到3次，就拒绝提供SSH列表中的这个IP服务。5分钟后即可恢复（更改SSH端口也可）</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -I INPUT -p tcp --dport 22 -m state NEW -m recent --update --seconds 300 --hitcount 3 --name SSH -j DROP</div></pre></td></tr></table></figure><h4 id="防止单个IP访问量过大"><a href="#防止单个IP访问量过大" class="headerlink" title="防止单个IP访问量过大"></a>防止单个IP访问量过大</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 30 -j DROP</div></pre></td></tr></table></figure><h4 id="防止ping攻击"><a href="#防止ping攻击" class="headerlink" title="防止ping攻击"></a>防止ping攻击</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/m -j ACCEPT</div></pre></td></tr></table></figure><h4 id="防止SYN攻击，轻量级预防"><a href="#防止SYN攻击，轻量级预防" class="headerlink" title="防止SYN攻击，轻量级预防"></a>防止SYN攻击，轻量级预防</h4><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -N syn-flood</div><div class="line">iptables -A INPUT -p tcp –syn -j syn-flood</div><div class="line">iptables -I syn-flood -p tcp -m limit –limit 3/s –limit-burst 6 -j RETURN</div><div class="line">iptables -A syn-flood -j REJECT</div></pre></td></tr></table></figure><p>开启81端口：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -I INPUT -i eth0 -p tcp –dport 81 -j ACCEPT</div><div class="line">iptables -I OUTPUT -o eth0 -p tcp –sport 81 -j ACCEPT</div></pre></td></tr></table></figure><p></p><p>关闭81端口：<br></p><figure class="highlight plain"><table><tr><td class="code"><pre><div class="line">iptables -I INPUT -i eth0 -p tcp –dport 81 -j DROP</div><div class="line">iptables -I OUTPUT -o eth0 -p tcp –sport 81 -j DROP</div></pre></td></tr></table></figure><p></p></div><footer><div class="clearfix"></div></footer></article></div></div><footer id="footer"><div class="copyright">&copy; 2017 <a href="/">(^_^)</a></div><div class="theme-copyright">Theme by <a href="https://github.com/orderedlist" target="_blank">orderedlist</a> | Redesign by <a href="http://heroicyang.com/" target="_blank">Heroic Yang</a></div><div class="clearfix"></div></footer><script src="//apps.bdimg.com/libs/jquery/2.0.3/jquery.min.js"></script><script src="/js/all.js"></script><script type="text/javascript"> var showNavBar = true; var expandNavBar = true;  $(document).ready(function(){    var h1s = $("body").find("h1");    var h2s = $("body").find("h2");    var h3s = $("body").find("h3");    var h4s = $("body").find("h4");    var h5s = $("body").find("h5");    var h6s = $("body").find("h6");    var headCounts = [h1s.length, h2s.length, h3s.length, h4s.length, h5s.length, h6s.length];    var vH1Tag = null;    var vH2Tag = null;    for(var i = 0; i< headCounts.length; i++){        if(headCounts[i] > 0){            if(vH1Tag == null){                vH1Tag = 'h' + (i + 1);            }else{                vH2Tag = 'h' + (i + 1);            }        }    }    if(vH1Tag == null){        return;    }    $("body").prepend('<div class="BlogAnchor">' + 		'<span style="color:red;position:absolute;top:1px;left:2px;cursor:pointer;font-family:Segoe MDL2 Assets;" onclick="$(\'.BlogAnchor\').hide();"></span>' +        '<p>' +             '<b id="AnchorContentToggle" title="收起" style="cursor:pointer;">目录▲</b>' +         '</p>' +         '<div class="AnchorContent" id="AnchorContent"></div>' +     '</div>' );    var vH1Index = 0;    var vH2Index = 0;    $("body").find("h1,h2,h3,h4,h5,h6").each(function(i,item){        var id = '';        var name = '';        var tag = $(item).get(0).tagName.toLowerCase();        var className = '';        if(tag == vH1Tag){            id = name = ++vH1Index;            name = id;            vH2Index = 0;            className = 'item_h1';        }else if(tag == vH2Tag){            id = vH1Index + '_' + ++vH2Index;            name = vH1Index + '.' + vH2Index;            className = 'item_h2';        }        $(item).attr("id","wow"+id);		$(item).addClass("wow_head");        $("#AnchorContent").css('max-height', ($(window).height() - 180) + 'px');        $("#AnchorContent").append('<li><a class="nav_item '+className+' anchor-link" onclick="return false;" href="#" link="#wow'+id+'">'+name+" · "+$(this).text()+'</a></li>');    });    $("#AnchorContentToggle").click(function(){        var text = $(this).html();        if(text=="目录▲"){            $(this).html("目录▼");            $(this).attr({"title":"展开"});        }else{            $(this).html("目录▲");            $(this).attr({"title":"收起"});        }        $("#AnchorContent").toggle();    });    $(".anchor-link").click(function(){        $("html,body").animate({scrollTop: $($(this).attr("link")).offset().top}, 500);    });		var headerNavs = $(".BlogAnchor li .nav_item");	var headerTops = [];	$(".wow_head").each(function(i, n){		headerTops.push($(n).offset().top);	});	$(window).scroll(function(){		var scrollTop = $(window).scrollTop();		$.each(headerTops, function(i, n){			var distance = n - scrollTop;			if(distance >= 0){				$(".BlogAnchor li .nav_item.current").removeClass('current');				$(headerNavs[i]).addClass('current');				return false;			}		});	});	if(!showNavBar){		$('.BlogAnchor').hide();	}	if(!expandNavBar){		$(this).html("目录▼");        $(this).attr({"title":"展开"});		$("#AnchorContent").hide();	} });</script><style>    .BlogAnchor {        padding: 10px;        position: fixed;        right: 4px;        top: 48px;        border: 1px ridge;        width: 254px;    }    .BlogAnchor p {        font-size: 18px;        color: #15a230;        margin: 0 0 0.3rem 0;        text-align: right;    }    .BlogAnchor .AnchorContent {        padding: 5px 0px;        overflow: auto;    }    .BlogAnchor li{        text-indent: 0.5rem;        font-size: 14px;        list-style: none;    }	.BlogAnchor li .nav_item{		padding: 3px;	}    .BlogAnchor li .item_h1{        margin-left: 0rem;    }    .BlogAnchor li .item_h2{        margin-left: 2rem;        font-size: 0.8rem;    }	.BlogAnchor li .nav_item.current{		color: white;		background-color: #5cc26f;		border-radius: 5px;	}    #AnchorContentToggle {        font-size: 13px;        font-weight: normal;        color: #FFF;        display: inline-block;        line-height: 20px;        background: #5cc26f;        font-style: normal;        padding: 1px 8px;    }    .BlogAnchor a:hover {        color: #5cc26f;    }    .BlogAnchor a {        text-decoration: none;    }</style>
</body><!-- rebuild by neat -->